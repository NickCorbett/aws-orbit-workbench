AWSTemplateFormatVersion: '2010-09-09'
Description: |
  DataMaker Toolkit Stack - ${env_name}
Resources:
  Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: datamaker-${env_name}-toolkit-${account_id}
      Tags: 
        - Key: Env
          Value: datamaker-${env_name}
      VersioningConfiguration:
        Status: Suspended
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: CleaningUp
            Status: Enabled
            ExpirationInDays: 1
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
            NoncurrentVersionExpirationInDays: 1
  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: datamaker-toolkit-${env_name}-codebuild
      AssumeRolePolicyDocument:
        Statement:
        - Action: ['sts:AssumeRole']
          Effect: Allow
          Principal:
            Service: [codebuild.amazonaws.com]
        Version: '2012-10-17'
      Path: /
      Policies:
        - PolicyName: CodeBuildAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:*
                  - cognito-idp:CreateUserPool
                  - cognito-idp:DeleteUserPool
                  - cognito-idp:CreateUserPoolClient
                  - cognito-idp:DeleteUserPoolClient
                  - cognito-identity:CreateIdentityPool
                  - cognito-identity:DeleteIdentityPool
                  - cognito-identity:UntagResource
                  - cognito-identity:TagResource
                  - cognito-identity:SetIdentityPoolRoles
                  - ec2:allocateAddress
                  - ec2:DeleteSubnet
                  - ec2:CreateNatGateway
                  - ec2:DeleteRoute
                  - ec2:DeleteNetworkInterface
                  - ec2:CreateVpc
                  - ec2:CreateRouteTable
                  - ec2:DeleteRouteTable
                  - ec2:CreateNetworkInterface
                  - ec2:DeleteVolume
                  - ec2:CreateRoute
                  - ec2:CreateSecurityGroup
                  - ec2:DeleteSecurityGroup
                  - ec2:DeleteNatGateway
                  - ec2:CreateInternetGateway
                  - ec2:DeleteInternetGateway
                  - ec2:DeleteVpc
                  - ec2:CreateSubnet
                  - ec2:DescribeVpcs
                  - ec2:describeAddresses
                  - ec2:DescribeInternetGateways
                  - ec2:releaseAddress
                  - ec2:ModifyVpcAttribute
                  - ec2:createTags
                  - ec2:DescribeAvailabilityZones
                  - ec2:DescribeAccountAttributes
                  - ec2:DescribeRouteTables
                  - ec2:DescribeSubnets
                  - ec2:AttachInternetGateway
                  - ec2:DetachInternetGateway
                  - ec2:ModifySubnetAttribute
                  - ec2:DescribeNatGateways
                  - ec2:AssociateRouteTable
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DescribeSecurityGroups
                  - ec2:DisassociateRouteTable
                Resource: '*'
              - Effect: Allow
                Action:
                  - s3:*
                Resource:
                  - arn:aws:s3:::datamaker-${env_name}-toolkit-${account_id}/*
                  - arn:aws:s3:::datamaker-${env_name}-toolkit-${account_id}
              - Effect: Allow
                Action:
                    - codebuild:CreateReportGroup
                    - codebuild:CreateReport
                    - codebuild:UpdateReport
                    - codebuild:BatchPutTestCases
                    - codebuild:BatchPutCodeCoverages
                Resource:
                  - arn:aws:codebuild:*
              - Effect: Allow
                Action:
                  - cloudformation:*
                Resource:
                  - arn:aws:cloudformation:${region}:${account_id}:stack/datamaker-${env_name}*
              - Effect: Allow
                Action:
                  - iam:GetRole
                  - iam:GetRolePolicy
                  - iam:CreateRole
                  - iam:AttachRolePolicy
                  - iam:PutRolePolicy
                  - iam:DetachRolePolicy
                  - iam:DeleteRolePolicy
                  - iam:DeleteRole
                  - iam:UntagRole
                  - iam:ListRoleTags
                  - iam:TagRole
                  - iam:PassRole
                Resource:
                  - arn:aws:iam::${account_id}:role/datamaker-${env_name}-eks-cluster-role
                  - arn:aws:iam::${account_id}:role/datamaker-${env_name}-eks-nodegroup-role
                  - arn:aws:iam::${account_id}:role/datamaker-${env_name}-cognito-authenticated-identity-role
                  - arn:aws:iam::${account_id}:role/datamaker-${env_name}-cognito-unauthenticated-identity-role
              - Effect: Allow
                Action:
                  - ssm:GetParameters
                  - ssm:DescribeParameters
                  - ssm:GetParameter
                  - ssm:DescribeParameter
                  - ssm:PutParameter
                  - ssm:AddTagsToResource
                  - ssm:DeleteParameter
                Resource:
                  - arn:aws:ssm:${region}:${account_id}:parameter/datamaker/${env_name}/manifest
                  - arn:aws:ssm:${region}:${account_id}:parameter/datamaker/${env_name}/teams/*
  CodeBuild:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: datamaker-${env_name}
      Tags: 
        - Key: Env
          Value: datamaker-${env_name}
      Description: DataMaker CLI backend.
      ServiceRole: !Ref CodeBuildRole
      Artifacts:
        Type: NO_ARTIFACTS
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_MEDIUM
        Image: aws/codebuild/standard:4.0
      Source:
        Type: NO_SOURCE
        BuildSpec:  |
          version: 0.2
          phases:
            install:
              runtime-versions:
                python: 3.7
                nodejs: 12
            build:
              commands:
                - ls -la
      TimeoutInMinutes: 20
      LogsConfig:
        CloudWatchLogs: 
          Status: ENABLED
          GroupName: /aws/codebuild/datamaker-${env_name}
        S3Logs: 
          Status: DISABLED
